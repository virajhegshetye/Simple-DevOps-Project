I understand you’d like to revert to a solution that doesn’t use Microsoft Copilot Studio, focusing instead on a traditional Azure setup using the Azure Portal UI (as requested previously) and Azure services, similar to the earlier Java-based solutions. This will involve building the "VoiceCard AI" application for visually challenged users using a Java-based Spring Boot application (as in the pre-Copilot Studio solutions), with Azure services set up via the Azure Portal UI instead of Azure CLI. We’ll provide two solutions:

- **Solution 1:** Real-time calling using Azure Communication Services (ACS) to handle actual phone calls to a toll-free number.
- **Solution 2:** Mocked calling for a hackathon demo, simulating the call flow without a real ACS subscription.

This solution will mirror the structure of the earlier Java-based solutions, but Step 2 will be updated to use the Azure Portal UI for setting up Azure services, replacing the Azure CLI commands.

---

###

```markdown
# VoiceCard AI: Complete End-to-End Solution Using Azure Portal UI (Without Copilot Studio)

This document provides a complete step-by-step solution for "VoiceCard AI," a voice-driven application designed for visually challenged users. The application allows users to call a toll-free customer care number, generate a credit card quotation ID using a Quotation API, and handle follow-up questions—all through voice-based interaction. We’ll implement two solutions:

- **Solution 1:** Real-time calling using Azure Communication Services (ACS) to handle actual phone calls.
- **Solution 2:** Mocked calling for a hackathon demo, simulating the call flow without a real ACS subscription.

We’ll build the application using a Java 21 Spring Boot application, integrating with Azure services (Speech Services, ACS, etc.), and set up all Azure services using the **Azure Portal UI** instead of Azure CLI.

## Key Features
- Users call a toll-free customer care number (real or mocked).
- The system guides them through the credit card quotation process using voice prompts.
- A quotation ID is generated by calling a mock Quotation API.
- Follow-up questions are handled during the same call.
- Accessibility for visually challenged users with voice-only interaction.

## Prerequisites
- **Java 21** installed.
- **Maven** for building the Java project.
- **VS Code** or **IntelliJ** for coding.
- **Node.js** and **npm** for the mock API.
- **PostgreSQL** for data storage.
- **Azure Account** with access to:
  - Azure Communication Services (ACS) for Solution 1.
  - Azure Cognitive Services Speech Service for voice interaction.
  - Azure Key Vault, Application Insights, and Azure AD B2C (optional).

## Today's Date and Time
- **Date and Time:** 03:39 PM IST, Monday, June 02, 2025.

---

## Step 1: Set Up Your Development Environment

### 1.1 Verify Java 21
- Confirm Java 21 is installed:
  ```bash
  java -version
  ```
  Expected output:
  ```
  java version "21" 2023-09-19 LTS
  ```
- Set `JAVA_HOME`:
  - On Windows: `setx JAVA_HOME "C:\Program Files\Java\jdk-21" /M`
  - On macOS/Linux: Add to `~/.bashrc` or `~/.zshrc`:
    ```bash
    export JAVA_HOME=/path/to/jdk-21
    source ~/.bashrc
    ```
- Verify: `echo $JAVA_HOME`.

### 1.2 Install Other Tools
- **Maven**: Download from [apache.org](https://maven.apache.org/download.cgi), extract, and add to `PATH`. Verify: `mvn -version`.
- **VS Code/IntelliJ**: Install [VS Code](https://code.visualstudio.com/) or [IntelliJ IDEA](https://www.jetbrains.com/idea/). Add Java extensions if using VS Code.
- **Node.js and npm**: Install [Node.js](https://nodejs.org/). Verify: `node -v` and `npm -v`.
- **PostgreSQL**: Install [PostgreSQL](https://www.postgresql.org/download/). Set a password (e.g., `your-postgres-password`). Create a database:
  ```bash
  psql -U postgres
  CREATE DATABASE creditcard_db;
  \q
  ```

### 1.3 Set Up the Mock Quotation API
Create a mock API for generating quotation IDs:

In `mock-creditcard-api/server.js`:

```javascript
const express = require('express');
const app = express();
app.use(express.json());

app.post('/api/creditcard/apply', (req, res) => {
    const { name, income, phone } = req.body;
    const quotationId = `QUOT-${Math.random().toString(36).substring(2, 8)}`;
    res.json({ name, phone, quotationId });
});

app.listen(3000, () => console.log('Mock Quotation API running on port 3000'));
```

To set up:
1. Create a directory: `mock-creditcard-api`.
2. Initialize a Node.js project:
   ```bash
   cd mock-creditcard-api
   npm init -y
   npm install express
   ```
3. Save the code as `server.js`.
4. Start the API:
   ```bash
   node server.js
   ```

---

## Step 2: Set Up Azure Services Using Azure Portal UI

We’ll set up the necessary Azure services (Resource Group, Speech Service, Key Vault, Azure AD B2C, Application Insights, and ACS for Solution 1) using the Azure Portal UI.

### 2.1 Create an Azure Account
1. Go to [azure.com](https://azure.com) and sign up for a free account ($200 credit for 30 days).
2. Sign in to the Azure Portal at [portal.azure.com](https://portal.azure.com).

### 2.2 Set Up a Resource Group
1. In the Azure Portal, click **Create a resource** (or use the search bar and type "Resource group").
2. Click **Create** under "Resource group".
3. Fill in the details:
   - **Resource group:** `voicecard-rg`.
   - **Region:** East US.
4. Click **Review + create**, then **Create**.

### 2.3 Create a Speech Service (For Both Solutions)
1. In the Azure Portal, click **Create a resource**.
2. Search for **Speech** and select **Speech** under Azure Cognitive Services.
3. Click **Create**.
4. Fill in the details:
   - **Subscription:** Select your subscription.
   - **Resource group:** `voicecard-rg`.
   - **Region:** East US.
   - **Name:** `voicecard-speech`.
   - **Pricing tier:** Free F0 (for demo purposes; upgrade to a paid tier for production).
5. Click **Review + create**, then **Create**.
6. Once deployed, go to the resource:
   - Navigate to **Keys and Endpoint** in the left sidebar.
   - Note **Key 1** (e.g., `your-speech-key`) and **Location/Region** (e.g., `eastus`).

### 2.4 Create a Key Vault
1. In the Azure Portal, click **Create a resource**.
2. Search for **Key Vault** and select **Key Vault**.
3. Click **Create**.
4. Fill in the details:
   - **Subscription:** Select your subscription.
   - **Resource group:** `voicecard-rg`.
   - **Key vault name:** `voicecard-vault`.
   - **Region:** East US.
   - **Pricing tier:** Standard.
5. Click **Review + create**, then **Create**.
6. Once deployed, go to the Key Vault resource:
   - Navigate to **Secrets** in the left sidebar.
   - Click **+ Generate/Import**.
   - Create a secret:
     - **Name:** `speech-key`.
     - **Value:** `your-speech-key` (from Step 2.3).
   - Click **Create**.
7. Note the Key Vault URI:
   - Go to **Overview**.
   - Copy the **Vault URI** (e.g., `https://voicecard-vault.vault.azure.net/`).

### 2.5 Set Up Azure Active Directory B2C (Optional)
1. In the Azure Portal, click **Create a resource**.
2. Search for **Azure Active Directory B2C** and select it.
3. Click **Create**.
4. Choose **Create a new Azure AD B2C Tenant**:
   - **Tenant name:** `VoiceCardB2C`.
   - **Initial domain name:** `voicecardb2c`.
   - **Country/Region:** United States.
   - Click **Review + create**, then **Create**.
5. Once the tenant is created, link it to your subscription:
   - Go to **Azure Active Directory** in the Azure Portal.
   - Switch to the `VoiceCardB2C` directory.
   - Go to **App registrations** > **New registration**.
   - **Name:** `voicecard-app`.
   - **Redirect URI:** `http://localhost:8080/login/oauth2/code/azure`.
   - Click **Register**.
   - Note the **Application (client) ID**.
6. Create a client secret:
   - Go to **Certificates & secrets**.
   - Click **+ New client secret**.
   - **Description:** `voicecard-secret`.
   - Click **Add**.
   - Note the **Client Secret** value.

### 2.6 Create an Application Insights Resource (Optional)
1. In the Azure Portal, click **Create a resource**.
2. Search for **Application Insights** and select it.
3. Click **Create**.
4. Fill in the details:
   - **Subscription:** Select your subscription.
   - **Resource group:** `voicecard-rg`.
   - **Name:** `voicecard-insights`.
   - **Region:** East US.
   - **Resource Mode:** Classic.
5. Click **Review + create**, then **Create**.
6. Once deployed, go to the resource:
   - Navigate to **Overview**.
   - Note the **Instrumentation Key** (e.g., `your-instrumentation-key`).

### 2.7 Set Up Azure Communication Services (For Solution 1 Only)
If you’re implementing Solution 1 (real-time calling), set up ACS:
1. In the Azure Portal, click **Create a resource**.
2. Search for **Communication Services** and select **Azure Communication Services**.
3. Click **Create**.
4. Fill in the details:
   - **Subscription:** Select your subscription.
   - **Resource group:** `voicecard-rg`.
   - **Resource name:** `voicecard-acs`.
   - **Data location:** United States.
5. Click **Review + create**, then **Create**.
6. Once deployed, go to the resource:
   - Navigate to **Keys** in the left sidebar.
   - Note the **Connection String** (e.g., `endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key`).
7. Acquire a toll-free number:
   - Go to **Phone Numbers** in the left sidebar.
   - Click **Get**.
   - **Type:** Toll-Free.
   - **Country/Region:** United States.
   - **Capabilities:** Calling + SMS (Inbound + Outbound).
   - Search and select a number (e.g., `+18001234567`).
   - Click **Get selected number**.
8. Store the ACS connection string in Key Vault:
   - Go back to your Key Vault (`voicecard-vault`).
   - Navigate to **Secrets**.
   - Click **+ Generate/Import**.
   - Create a secret:
     - **Name:** `acs-connection-string`.
     - **Value:** `endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key`.
   - Click **Create**.

---

## Step 3: Create the Java Application

### 3.1 Project Structure
The project structure for the Spring Boot application (`voicecard-ai`) is as follows:

```
voicecard-ai/
├── pom.xml
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── voicecard/
│   │   │           ├── VoiceCardAiApplication.java
│   │   │           ├── config/
│   │   │           │   ├── AppInsightsConfig.java
│   │   │           │   └── SecurityConfig.java
│   │   │           ├── controller/
│   │   │           │   ├── CallHandlerController.java (Solution 1)
│   │   │           │   └── DemoController.java (Solution 2)
│   │   │           ├── model/
│   │   │           │   └── Application.java
│   │   │           ├── repository/
│   │   │           │   └── ApplicationRepository.java
│   │   │           ├── service/
│   │   │           │   ├── SpeechService.java
│   │   │           │   ├── CallingService.java (Solution 1)
│   │   │           │   ├── MockCallingService.java (Solution 2)
│   │   │           │   ├── QuotationService.java
│   │   │           │   ├── ApplicationService.java
│   │   │           │   └── KeyVaultService.java
│   │   └── resources/
│   │       ├── application.properties
│   │       └── templates/
│   │           └── demo-result.html (Solution 2)
└── mock-creditcard-api/
    └── server.js
```

### 3.2 Create a Spring Boot Project
1. Go to [start.spring.io](https://start.spring.io/).
2. Fill in:
   - Project: Maven
   - Language: Java
   - Spring Boot: 3.2.5
   - Group: `com.voicecard`
   - Artifact: `voicecard-ai`
   - Java: 21
   - Dependencies: Add "Spring Web", "Spring Data JPA", "PostgreSQL Driver", "Spring Boot Starter Thymeleaf".
3. Generate, download, and open in your IDE.

### 3.3 `pom.xml`
The `pom.xml` file includes all dependencies for ACS (Solution 1), Speech SDK, Key Vault, Application Insights, and Spring Security:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.voicecard</groupId>
    <artifactId>voicecard-ai</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>voicecard-ai</name>
    <description>VoiceCard AI project for credit card applications</description>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.5</version>
        <relativePath/>
    </parent>

    <properties>
        <java.version>21</java.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- Azure Communication Services Calling SDK (Solution 1) -->
        <dependency>
            <groupId>com.azure</groupId>
            <artifactId>azure-communication-calling</artifactId>
            <version>1.2.1</version>
        </dependency>
        <dependency>
            <groupId>com.azure</groupId>
            <artifactId>azure-communication-common</artifactId>
            <version>1.2.1</version>
        </dependency>

        <!-- Azure Speech SDK -->
        <dependency>
            <groupId>com.microsoft.azure.cognitiveservices</groupId>
            <artifactId>azure-cognitiveservices-speech</artifactId>
            <version>1.38.0</version>
        </dependency>

        <!-- Azure Key Vault -->
        <dependency>
            <groupId>com.azure</groupId>
            <artifactId>azure-identity</artifactId>
            <version>1.12.0</version>
        </dependency>
        <dependency>
            <groupId>com.azure</groupId>
            <artifactId>azure-security-keyvault-secrets</artifactId>
            <version>4.8.0</version>
        </dependency>

        <!-- Application Insights -->
        <dependency>
            <groupId>com.microsoft.applicationinsights</groupId>
            <artifactId>applicationinsights-core</artifactId>
            <version>3.5.1</version>
        </dependency>

        <!-- HTTP Client for Quotation API -->
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
            <version>4.5.14</version>
        </dependency>

        <!-- Spring Security for Azure AD B2C -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-oauth2-client</artifactId>
        </dependency>

        <!-- JSON Processing -->
        <dependency>
            <groupId>org.json</groupId>
            <artifactId>json</artifactId>
            <version>20231013</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

**Note:** For Solution 2 (mocked calling), you can remove the ACS dependencies (`azure-communication-calling` and `azure-communication-common`).

### 3.4 `application.properties`
The `application.properties` file contains all configurations:

```properties
# PostgreSQL
spring.datasource.url=jdbc:postgresql://localhost:5432/creditcard_db
spring.datasource.username=postgres
spring.datasource.password=your-postgres-password
spring.jpa.hibernate.ddl-auto=update

# Azure Speech Service
azure.speech.key=your-speech-key
azure.speech.region=eastus

# Azure Key Vault
azure.keyvault.uri=https://voicecard-vault.vault.azure.net/
azure.keyvault.client-id=your-adb2c-client-id
azure.keyvault.client-secret=your-adb2c-client-secret
azure.keyvault.tenant-id=your-adb2c-tenant-id

# Application Insights
applicationinsights.instrumentation-key=your-instrumentation-key

# Mock Quotation API
creditcard.api.url=http://localhost:3000/api/creditcard/apply

# Azure Communication Services (Solution 1)
acs.connection-string=endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key
acs.toll-free-number=+18001234567

# Spring Security OAuth2 for Azure AD B2C
spring.security.oauth2.client.registration.azure.client-id=your-adb2c-client-id
spring.security.oauth2.client.registration.azure.client-secret=your-adb2c-client-secret
spring.security.oauth2.client.registration.azure.scope=openid,profile
spring.security.oauth2.client.registration.azure.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.azure.redirect-uri=http://localhost:8080/login/oauth2/code/azure
spring.security.oauth2.client.provider.azure.authorization-uri=https://voicecardb2c.b2clogin.com/voicecardb2c.onmicrosoft.com/B2C_1_signup_signin/oauth2/v2.0/authorize
spring.security.oauth2.client.provider.azure.token-uri=https://voicecardb2c.b2clogin.com/voicecardb2c.onmicrosoft.com/B2C_1_signup_signin/oauth2/v2.0/token
spring.security.oauth2.client.provider.azure.user-info-uri=https://graph.microsoft.com/oidc/userinfo
spring.security.oauth2.client.provider.azure.user-name-attribute=preferred_username
```

Replace placeholders with values from Step 2. For Solution 2, remove the ACS-related properties (`acs.connection-string` and `acs.toll-free-number`).

### 3.5 `VoiceCardAiApplication.java`
The main application class to start the Spring Boot application:

In `src/main/java/com/voicecard/VoiceCardAiApplication.java`:

```java
package com.voicecard;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class VoiceCardAiApplication {
    public static void main(String[] args) {
        SpringApplication.run(VoiceCardAiApplication.class, args);
    }
}
```

### 3.6 `Application.java` (Model)
The data model for storing application details:

In `src/main/java/com/voicecard/model/Application.java`:

```java
package com.voicecard.model;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;

@Entity
public class Application {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String phone;
    private double income;
    private String decision;

    // Getters and Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    public String getPhone() { return phone; }
    public void setPhone(String phone) { this.phone = phone; }
    public double getIncome() { return income; }
    public void setIncome(double income) { this.income = income; }
    public String getDecision() { return decision; }
    public void setDecision(String decision) { this.decision = decision; }
}
```

### 3.7 `ApplicationRepository.java`
The JPA repository for database operations:

In `src/main/java/com/voicecard/repository/ApplicationRepository.java`:

```java
package com.voicecard.repository;

import com.voicecard.model.Application;
import org.springframework.data.jpa.repository.JpaRepository;

public interface ApplicationRepository extends JpaRepository<Application, Long> {
}
```

### 3.8 `SpeechService.java`
The service to handle speech-to-text and text-to-speech:

In `src/main/java/com/voicecard/service/SpeechService.java`:

```java
package com.voicecard.service;

import com.microsoft.cognitiveservices.speech.*;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

@Service
public class SpeechService {
    @Value("${azure.speech.key}")
    private String speechKey;

    @Value("${azure.speech.region}")
    private String speechRegion;

    public String recognizeSpeech() throws Exception {
        SpeechConfig config = SpeechConfig.fromSubscription(speechKey, speechRegion);
        try (SpeechRecognizer recognizer = new SpeechRecognizer(config)) {
            SpeechRecognitionResult result = recognizer.recognizeOnceAsync().get();
            return result.getText().trim();
        }
    }

    public void synthesizeSpeech(String text) throws Exception {
        SpeechConfig config = SpeechConfig.fromSubscription(speechKey, speechRegion);
        try (SpeechSynthesizer synthesizer = new SpeechSynthesizer(config)) {
            synthesizer.SpeakTextAsync(text).get();
        }
    }
}
```

### 3.9 `CallingService.java` (Solution 1)
The service to handle incoming calls to the toll-free number:

In `src/main/java/com/voicecard/service/CallingService.java`:

```java
package com.voicecard.service;

import com.azure.communication.calling.*;
import com.azure.communication.common.CommunicationTokenCredential;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.concurrent.atomic.AtomicBoolean;

@Service
public class CallingService {
    @Value("${acs.connection-string}")
    private String acsConnectionString;

    @Value("${acs.toll-free-number}")
    private String tollFreeNumber;

    private CallAgent callAgent;
    private Call currentCall;
    private final AtomicBoolean isCallActive = new AtomicBoolean(false);

    public void initializeCallAgent() throws Exception {
        CommunicationTokenCredential credential = new CommunicationTokenCredential(acsConnectionString);
        CallClient callClient = new CallClient();
        callAgent = callClient.createCallAgent(credential).get();
        callAgent.addOnIncomingCallListener(this::handleIncomingCall);
    }

    private void handleIncomingCall(IncomingCall incomingCall) {
        if (isCallActive.get()) {
            incomingCall.reject().block();
            return;
        }

        isCallActive.set(true);
        currentCall = incomingCall.accept(null).block();
        currentCall.addOnStateChangedListener(state -> {
            if (state.getState() == CallState.DISCONNECTED) {
                isCallActive.set(false);
                currentCall = null;
            }
        });
    }

    public Call getCurrentCall() {
        return currentCall;
    }

    public boolean isCallActive() {
        return isCallActive.get();
    }

    public void hangUp() {
        if (currentCall != null) {
            currentCall.hangUp(null).block();
        }
    }
}
```

### 3.10 `MockCallingService.java` (Solution 2)
The mocked calling service to simulate a phone call by logging interactions in the console:

In `src/main/java/com/voicecard/service/MockCallingService.java`:

```java
package com.voicecard.service;

import org.springframework.stereotype.Service;

import java.util.concurrent.atomic.AtomicBoolean;

@Service
public class MockCallingService {
    private final AtomicBoolean isCallActive = new AtomicBoolean(false);

    public void initializeCallAgent() {
        System.out.println("[MockCallingService] Simulating initialization of call agent...");
    }

    public void simulateIncomingCall() {
        if (isCallActive.get()) {
            System.out.println("[MockCallingService] Another call is already active. Rejecting new call.");
            return;
        }

        System.out.println("[MockCallingService] Simulating incoming call from +18001234567...");
        isCallActive.set(true);
        System.out.println("[MockCallingService] Call accepted. Call is now active.");
    }

    public boolean isCallActive() {
        return isCallActive.get();
    }

    public void hangUp() {
        if (isCallActive.get()) {
            System.out.println("[MockCallingService] Simulating call hang-up...");
            isCallActive.set(false);
        } else {
            System.out.println("[MockCallingService] No active call to hang up.");
        }
    }
}
```

### 3.11 `QuotationService.java`
The service to generate a quotation ID by calling the mock Quotation API:

In `src/main/java/com/voicecard/service/QuotationService.java`:

```java
package com.voicecard.service;

import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.UUID;

@Service
public class QuotationService {
    @Value("${creditcard.api.url}")
    private String quotationApiUrl;

    public String generateQuotationId(String name, String phone, double income) throws Exception {
        try (var client = HttpClients.createDefault()) {
            var post = new HttpPost(quotationApiUrl);
            var json = new JSONObject();
            json.put("name", name);
            json.put("phone", phone);
            json.put("income", income);
            post.setEntity(new StringEntity(json.toString()));
            post.setHeader("Content-Type", "application/json");
            var response = EntityUtils.toString(client.execute(post).getEntity());
            var responseJson = new JSONObject(response);
            // Mock a quotation ID
            String quotationId = "QUOT-" + UUID.randomUUID().toString().substring(0, 8);
            return quotationId;
        }
    }
}
```

### 3.12 `ApplicationService.java`
The service to manage the application process, compatible with both real and mocked calling services:

In `src/main/java/com/voicecard/service/ApplicationService.java`:

```java
package com.voicecard.service;

import com.voicecard.model.Application;
import com.voicecard.repository.ApplicationRepository;
import com.microsoft.applicationinsights.TelemetryClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class ApplicationService {
    private final SpeechService speechService;
    private final Object callingService; // Can be either CallingService or MockCallingService
    private final QuotationService quotationService;
    private final ApplicationRepository repository;
    @Autowired
    private TelemetryClient telemetryClient;

    public ApplicationService(SpeechService speechService, Object callingService,
                              QuotationService quotationService, ApplicationRepository repository) {
        this.speechService = speechService;
        this.callingService = callingService;
        this.quotationService = quotationService;
        this.repository = repository;
    }

    public void processApplication() throws Exception {
        // Ensure a call is active
        boolean isCallActive = callingService instanceof CallingService
                ? ((CallingService) callingService).isCallActive()
                : ((MockCallingService) callingService).isCallActive();
        if (!isCallActive) {
            throw new IllegalStateException("No active call to process.");
        }

        var app = new Application();

        // Step 1: Welcome the user and ask for their name
        speechService.synthesizeSpeech("Welcome to VoiceCard AI. This is an automated system to help you generate a credit card quotation ID. Please say your name.");
        var name = speechService.recognizeSpeech();
        app.setName(name);

        // Step 2: Ask for phone number
        speechService.synthesizeSpeech("Please say your phone number, one digit at a time, for example, 1 2 3 4 5 6 7 8 9 0.");
        var phone = speechService.recognizeSpeech();
        // Basic cleaning of the phone number (speech recognition may vary)
        phone = phone.replaceAll("[^0-9]", "");
        app.setPhone(phone);

        // Step 3: Ask for income
        speechService.synthesizeSpeech("Please say your annual income in dollars, for example, 50 thousand.");
        var incomeStr = speechService.recognizeSpeech();
        var income = parseIncome(incomeStr);
        app.setIncome(income);

        // Step 4: Generate quotation ID
        telemetryClient.trackEvent("Generating quotation ID for user: " + name);
        var quotationId = quotationService.generateQuotationId(name, phone, income);
        app.setDecision(quotationId);

        // Step 5: Save to database
        repository.save(app);

        // Step 6: Inform the user of the quotation ID
        speechService.synthesizeSpeech("Thank you, " + name + ". Your credit card quotation ID is " + quotationId + ". Please note this down.");

        // Step 7: Handle follow-up questions
        handleFollowUp();
    }

    private double parseIncome(String incomeStr) {
        // Handle common speech patterns, e.g., "50 thousand" or "50000"
        incomeStr = incomeStr.toLowerCase().replaceAll("[^0-9\\s]", "");
        if (incomeStr.contains("thousand")) {
            var number = Double.parseDouble(incomeStr.replace("thousand", "").trim());
            return number * 1000;
        }
        return Double.parseDouble(incomeStr.trim());
    }

    private void handleFollowUp() throws Exception {
        speechService.synthesizeSpeech("Do you have any follow-up questions about your quotation? Please say yes or no.");
        var response = speechService.recognizeSpeech().toLowerCase();
        if (response.contains("yes")) {
            speechService.synthesizeSpeech("Please state your question.");
            var question = speechService.recognizeSpeech();
            telemetryClient.trackEvent("Follow-up question from user: " + question);
            speechService.synthesizeSpeech("Thank you for your question: " + question + ". A customer care representative will follow up with you soon.");
        }
        speechService.synthesizeSpeech("Thank you for using VoiceCard AI. Goodbye!");
        if (callingService instanceof CallingService) {
            ((CallingService) callingService).hangUp();
        } else {
            ((MockCallingService) callingService).hangUp();
        }
    }
}
```

**Note:** The `callingService` is injected as an `Object` to support both `CallingService` (Solution 1) and `MockCallingService` (Solution 2). In a real application, you’d use dependency injection with profiles to switch between implementations.

### 3.13 `KeyVaultService.java`
The service to retrieve secrets from Azure Key Vault:

In `src/main/java/com/voicecard/service/KeyVaultService.java`:

```java
package com.voicecard.service;

import com.azure.identity.DefaultAzureCredentialBuilder;
import com.azure.security.keyvault.secrets.SecretClient;
import com.azure.security.keyvault.secrets.SecretClientBuilder;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

@Service
public class KeyVaultService {
    private final SecretClient secretClient;

    public KeyVaultService(@Value("${azure.keyvault.uri}") String keyVaultUri) {
        this.secretClient = new SecretClientBuilder()
                .vaultUrl(keyVaultUri)
                .credential(new DefaultAzureCredentialBuilder().build())
                .buildClient();
    }

    public String getSecret(String secretName) {
        return secretClient.getSecret(secretName).getValue();
    }
}
```

### 3.14 `CallHandlerController.java` (Solution 1)
The controller to handle incoming call events from ACS:

In `src/main/java/com/voicecard/controller/CallHandlerController.java`:

```java
package com.voicecard.controller;

import com.voicecard.service.ApplicationService;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class CallHandlerController {
    private final ApplicationService applicationService;

    public CallHandlerController(ApplicationService applicationService) {
        this.applicationService = applicationService;
    }

    @PostMapping("/webhook")
    public void handleCallEvent(@RequestBody String event) throws Exception {
        // ACS sends call events to this webhook
        // For simplicity, we assume the event indicates a new incoming call
        applicationService.processApplication();
    }
}
```

### 3.15 `DemoController.java` (Solution 2)
A controller to trigger the demo by simulating an incoming call:

In `src/main/java/com/voicecard/controller/DemoController.java`:

```java
package com.voicecard.controller;

import com.voicecard.service.ApplicationService;
import com.voicecard.service.MockCallingService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class DemoController {
    private final MockCallingService callingService;
    private final ApplicationService applicationService;

    public DemoController(MockCallingService callingService, ApplicationService applicationService) {
        this.callingService = callingService;
        this.applicationService = applicationService;
    }

    @GetMapping("/demo")
    public String startDemo(Model model) throws Exception {
        // Initialize the mock call agent
        callingService.initializeCallAgent();

        // Simulate an incoming call
        callingService.simulateIncomingCall();

        // Process the application (voice interaction will happen here)
        applicationService.processApplication();

        model.addAttribute("message", "Demo completed. Check the console for simulated call logs.");
        return "demo-result";
    }
}
```

### 3.16 `AppInsightsConfig.java`
The configuration for Application Insights:

In `src/main/java/com/voicecard/config/AppInsightsConfig.java`:

```java
package com.voicecard.config;

import com.microsoft.applicationinsights.TelemetryClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class AppInsightsConfig {
    @Value("${applicationinsights.instrumentation-key}")
    private String instrumentationKey;

    @Bean
    public TelemetryClient telemetryClient() {
        TelemetryClient client = new TelemetryClient();
        client.getContext().setInstrumentationKey(instrumentationKey);
        return client;
    }
}
```

### 3.17 `SecurityConfig.java`
The security configuration for Azure AD B2C:

In `src/main/java/com/voicecard/config/SecurityConfig.java`:

```java
package com.voicecard.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/webhook").permitAll() // Allow ACS webhook (Solution 1)
                .requestMatchers("/demo").authenticated() // Protect demo endpoint (Solution 2)
                .anyRequest().authenticated()
            )
            .oauth2Login();
        return http.build();
    }
}
```

### 3.18 `demo-result.html` (Solution 2)
A simple Thymeleaf template to display the demo result:

In `src/main/resources/templates/demo-result.html`:

```html
<!DOCTYPE html>
<html>
<head>
    <title>VoiceCard AI - Demo Result</title>
</head>
<body>
    <h1>VoiceCard AI Demo Result</h1>
    <p th:text="${message}"></p>
    <a href="/demo">Run Another Demo</a>
</body>
</html>
```

---

## Step 4: Set Up a Webhook for Incoming Calls (Solution 1)

To receive incoming call events, ACS needs a public webhook URL. For local testing, use `ngrok` to expose your local server.

1. **Install `ngrok`:**
   - Download and install [ngrok](https://ngrok.com/).
   - Start `ngrok` to expose your local server:
     ```bash
     ngrok http 8080
     ```
   - Note the public URL, e.g., `https://your-ngrok-subdomain.ngrok.io`.

2. **Configure ACS to Send Events to the Webhook:**
   - In the Azure Portal, go to your ACS resource (`voicecard-acs`):
     - Navigate to **Events** in the left sidebar.
     - Click **+ Event Subscription**.
     - **Name:** `VoiceCardWebhook`.
     - **Webhook URL:** `https://your-ngrok-subdomain.ngrok.io/webhook`.
     - **Events to Subscribe:** Select **Incoming Call**.
     - Click **Create**.

---

## Step 5: Test the Application

### 5.1 Start the Mock API
```bash
cd mock-creditcard-api
node server.js
```

### 5.2 Start the Spring Boot Application
```bash
cd voicecard-ai
mvn spring-boot:run
```

### 5.3 Test Solution 1 (Real-Time Calling)
1. **Call the Toll-Free Number:**
   - Use a phone to dial the toll-free number (`+18001234567`).
   - The system will answer the call and guide you through the process via voice:
     - "Welcome to VoiceCard AI... Please say your name."
     - "Please say your phone number, one digit at a time..."
     - "Please say your annual income..."
     - "Your credit card quotation ID is QUOT-XXXXXX..."
     - "Do you have any follow-up questions?..."
   - The call will end after the process is complete.
2. **Verify Database and Monitoring:**
   - Check the database:
     ```bash
     psql -U postgres -d creditcard_db
     SELECT * FROM application;
     ```
   - Check Application Insights in the Azure Portal for logs.

### 5.4 Test Solution 2 (Mocked Calling for Hackathon Demo)
1. Open a browser and go to `http://localhost:8080/demo`.
2. Log in via Azure AD B2C (if prompted).
3. The demo will start:
   - The `MockCallingService` will log messages to the console, simulating an incoming call:
     ```
     [MockCallingService] Simulating initialization of call agent...
     [MockCallingService] Simulating incoming call from +18001234567...
     [MockCallingService] Call accepted. Call is now active.
     ```
   - Follow the voice prompts to provide your name, phone number, income, and follow-up questions.
   - The simulated call will end with a console message:
     ```
     [MockCallingService] Simulating call hang-up...
     ```
4. The browser will display a result page: "Demo completed. Check the console for simulated call logs."
5. **Verify Database and Monitoring:**
   - Check the database as above.
   - Check Application Insights for logs.

---

## Step 6: Prepare for Hackathon Presentation (Solution 2)

### 6.1 Demonstrate the Flow
- Show the browser at `http://localhost:8080/demo` to start the demo.
- Use a microphone to speak your responses (name, phone number, income, follow-up questions).
- Point out the console logs to show the simulated call flow (e.g., "Simulating incoming call from +18001234567...").
- Highlight the voice prompts and responses, showing how the system is accessible for visually challenged users.
- Display the database entries to confirm the quotation ID was saved.

### 6.2 Explain the Mocked Calling
- Mention that real-time calling with ACS was mocked due to subscription constraints.
- Explain that `MockCallingService` simulates the call by logging messages, but the voice interaction (via Speech Service) and backend logic (quotation generation, database storage) are fully functional.
- If the hackathon judges ask about real calling, clarify that Solution 1 integrates ACS, as shown in Step 5.3.

---

## Accessibility Considerations

- **Voice-Only Interaction:** The entire process is voice-driven, with clear, slow prompts to assist visually challenged users.
- **Error Handling:** The system includes basic input parsing (e.g., for phone numbers and income) to handle speech recognition errors.
- **Follow-Up Support:** Users can ask follow-up questions, which are logged for later follow-up by a representative.

---

## Summary

- Built a voice-driven application for visually challenged users to generate credit card quotation IDs.
- **Solution 1:** Used Azure Communication Services to handle incoming calls to a toll-free number.
- **Solution 2:** Mocked calling functionality for a hackathon demo, simulating the call flow with console logs.
- Set up Azure services using the Azure Portal UI, replacing Azure CLI commands.
- Integrated Azure Speech Services for real-time voice interaction.
- Generated quotation IDs via a mock API.
- Supported follow-up questions via voice, with responses logged for later action.
- Ensured accessibility with clear, voice-only prompts and error handling.

This solution is now fully tailored for both real-time calling and a hackathon demo, using a Java-based approach with Azure services configured via the Azure Portal UI.
```

---

### **Key Changes Compared to Copilot Studio Solution**

- **Removed Copilot Studio:** The solution reverts to a Java-based Spring Boot application, similar to earlier solutions before Copilot Studio was introduced.
- **Azure Portal UI for Setup:** Step 2 uses the Azure Portal UI to set up all Azure services, replacing the Azure CLI commands from earlier solutions.
- **Java-Based Implementation:** The application logic (voice interaction, calling, quotation generation, etc.) is implemented in Java, using Spring Boot, instead of Copilot Studio’s conversational flows.
- **Direct Azure Service Integration:** Services like Azure Speech SDK and ACS are integrated directly in Java code, without relying on Power Automate flows or Copilot Studio’s voice channel.

This solution maintains the same functionality as the earlier Java-based solutions but ensures all Azure service setup is done via the Azure Portal UI, making it more accessible for users who prefer a graphical interface over command-line tools.