
### **VoiceCard_AI_Solution.md**

```markdown
# VoiceCard AI: Complete End-to-End Solution for Visually Challenged Users

This document provides a complete step-by-step solution for "VoiceCard AI," a voice-driven application designed for visually challenged users. The application allows users to call a toll-free customer care number, generate a credit card quotation ID using a Quotation API, and handle follow-up questions—all through voice-based interaction over a phone call. The solution uses **Azure Communication Services (ACS)** for real-time calling, **Azure Cognitive Services Speech SDK** for speech-to-text and text-to-speech, and runs on **Java 21**.

## Key Features
- Users call a toll-free customer care number.
- The system guides them through the credit card quotation process using voice prompts.
- A quotation ID is generated by calling a mock Quotation API.
- Follow-up questions are handled during the same call.
- Accessibility for visually challenged users with voice-only interaction.

## Prerequisites
- **Java 21** installed.
- **Maven** for building the Java project.
- **VS Code** or **IntelliJ** for coding.
- **Docker** (optional, for containerization).
- **Node.js** and **npm** for the mock API.
- **PostgreSQL** for data storage.
- **Azure CLI** for setting up Azure services.

## Today's Date and Time
- **Date and Time:** 12:22 PM IST, Monday, June 02, 2025.

---

## Step 1: Set Up Your Development Environment

### 1.1 Verify Java 21
- Confirm Java 21 is installed:
  ```bash
  java -version
  ```
  Expected output:
  ```
  java version "21" 2023-09-19 LTS
  ```
- Set `JAVA_HOME`:
  - On Windows: `setx JAVA_HOME "C:\Program Files\Java\jdk-21" /M`
  - On macOS/Linux: Add to `~/.bashrc` or `~/.zshrc`:
    ```bash
    export JAVA_HOME=/path/to/jdk-21
    source ~/.bashrc
    ```
- Verify: `echo $JAVA_HOME`.

### 1.2 Install Other Tools
- **Maven**: Download from [apache.org](https://maven.apache.org/download.cgi), extract, and add to `PATH`. Verify: `mvn -version`.
- **VS Code/IntelliJ**: Install [VS Code](https://code.visualstudio.com/) or [IntelliJ IDEA](https://www.jetbrains.com/idea/). Add Java extensions if using VS Code.
- **Docker**: Install [Docker Desktop](https://www.docker.com/products/docker-desktop). Verify: `docker --version`.
- **Node.js and npm**: Install [Node.js](https://nodejs.org/). Verify: `node -v` and `npm -v`.
- **PostgreSQL**: Install [PostgreSQL](https://www.postgresql.org/download/). Set a password (e.g., `your-postgres-password`). Create a database:
  ```bash
  psql -U postgres
  CREATE DATABASE creditcard_db;
  \q
  ```
- **Azure CLI**: Install from [learn.microsoft.com/en-us/cli/azure/install-azure-cli](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli). Verify: `az --version`.

---

## Step 2: Set Up Azure Services Using Azure CLI

### 2.1 Create an Azure Account
- Sign up for a free Azure account at [azure.com](https://azure.com) ($200 credit for 30 days).
- Log in via the CLI:
  ```bash
  az login
  ```

### 2.2 Set Up a Resource Group
Create a resource group named `voicecard-rg` in the East US region:
```bash
az group create --name voicecard-rg --location eastus
```

### 2.3 Create an Azure Communication Services (ACS) Resource
Create an ACS resource named `voicecard-acs`:
```bash
az communication create --name voicecard-acs --location global --data-location unitedstates --resource-group voicecard-rg
```
- Note the connection string:
  ```bash
  az communication list --resource-group voicecard-rg --query "[0].connectionString" --output tsv
  ```
  Example: `endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key`

### 2.4 Acquire a Toll-Free Number
1. Search for a toll-free number in the US:
   ```bash
   az communication phonenumber list-available --location US --type tollfree --assignment-type application --capabilities calling=inbound sms=inbound-outbound --quantity 1 --resource-group voicecard-rg --connection-string "endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key"
   ```
   Example output:
   ```
   Search id: search-123
   Reserved phone numbers:
   +18001234567
   ```
2. Purchase the toll-free number:
   ```bash
   az communication phonenumber purchase --search-id search-123 --resource-group voicecard-rg --connection-string "endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key"
   ```
3. Verify the purchased number:
   ```bash
   az communication phonenumber list --resource-group voicecard-rg --connection-string "endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key"
   ```

### 2.5 Create a Speech Service
1. Create a Speech Service resource:
   ```bash
   az cognitiveservices account create \
       --name voicecard-speech \
       --kind SpeechServices \
       --sku F0 \
       --location eastus \
       --resource-group voicecard-rg
   ```
2. Retrieve the Speech Service key and region:
   ```bash
   az cognitiveservices account keys list --name voicecard-speech --resource-group voicecard-rg --query key1 --output tsv
   ```
   Example: `your-speech-key`
   ```bash
   az cognitiveservices account show --name voicecard-speech --resource-group voicecard-rg --query location --output tsv
   ```
   Example: `eastus`

### 2.6 Create a Key Vault
Create a Key Vault to store secrets:
```bash
az keyvault create --name voicecard-vault --resource-group voicecard-rg --location eastus
```
- Store the ACS connection string and Speech Service key:
  ```bash
  az keyvault secret set --vault-name voicecard-vault --name acs-connection-string --value "endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key"
  az keyvault secret set --vault-name voicecard-vault --name speech-key --value "your-speech-key"
  ```
- Note the Key Vault URI:
  ```bash
  az keyvault show --name voicecard-vault --resource-group voicecard-rg --query properties.vaultUri --output tsv
  ```
  Example: `https://voicecard-vault.vault.azure.net/`

### 2.7 Set Up Azure Active Directory B2C
1. Create an Azure AD B2C tenant:
   ```bash
   az ad app create --display-name VoiceCardB2C
   az ad sp create --id <application-id-from-previous-command>
   az tenant create --display-name VoiceCardB2C --domain-name voicecardb2c --country-code US
   ```
   Note the tenant ID.

2. Switch to the B2C tenant:
   ```bash
   az login --tenant voicecardb2c.onmicrosoft.com
   ```

3. Register an application:
   ```bash
   az ad app create --display-name voicecard-app --reply-urls http://localhost:8080/login/oauth2/code/azure
   ```
   Note the **Application (client) ID**.

4. Create a client secret:
   ```bash
   az ad app credential reset --id <application-client-id> --append
   ```
   Note the **Client Secret**.

### 2.8 Create an Application Insights Resource
```bash
az monitor app-insights component create --app voicecard-insights --location eastus --resource-group voicecard-rg
```
- Note the Instrumentation Key:
  ```bash
  az monitor app-insights component show --app voicecard-insights --resource-group voicecard-rg --query instrumentationKey --output tsv
  ```
  Example: `your-instrumentation-key`

---

## Step 3: Create the Java Application

### 3.1 Project Structure
The project structure for the Spring Boot application (`voicecard-ai`) is as follows:

```
voicecard-ai/
├── pom.xml
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── voicecard/
│   │   │           ├── VoiceCardAiApplication.java
│   │   │           ├── config/
│   │   │           │   ├── AppInsightsConfig.java
│   │   │           │   └── SecurityConfig.java
│   │   │           ├── controller/
│   │   │           │   └── CallHandlerController.java
│   │   │           ├── model/
│   │   │           │   └── Application.java
│   │   │           ├── repository/
│   │   │           │   └── ApplicationRepository.java
│   │   │           ├── service/
│   │   │           │   ├── SpeechService.java
│   │   │           │   ├── CallingService.java
│   │   │           │   ├── QuotationService.java
│   │   │           │   ├── ApplicationService.java
│   │   │           │   └── KeyVaultService.java
│   │   └── resources/
│   │       └── application.properties
└── mock-creditcard-api/
    └── server.js
```

### 3.2 Create a Spring Boot Project
1. Go to [start.spring.io](https://start.spring.io/).
2. Fill in:
   - Project: Maven
   - Language: Java
   - Spring Boot: 3.2.5
   - Group: `com.voicecard`
   - Artifact: `voicecard-ai`
   - Java: 21
   - Dependencies: Add "Spring Web", "Spring Data JPA", "PostgreSQL Driver", "Spring Boot Starter Thymeleaf".
3. Generate, download, and open in your IDE.

### 3.3 `pom.xml`
The `pom.xml` file includes all dependencies for ACS, Speech SDK, Key Vault, Application Insights, and Spring Security:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.voicecard</groupId>
    <artifactId>voicecard-ai</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>voicecard-ai</name>
    <description>VoiceCard AI project for credit card applications</description>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.5</version>
        <relativePath/>
    </parent>

    <properties>
        <java.version>21</java.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- Azure Communication Services Calling SDK -->
        <dependency>
            <groupId>com.azure</groupId>
            <artifactId>azure-communication-calling</artifactId>
            <version>1.2.1</version>
        </dependency>
        <dependency>
            <groupId>com.azure</groupId>
            <artifactId>azure-communication-common</artifactId>
            <version>1.2.1</version>
        </dependency>

        <!-- Azure Speech SDK -->
        <dependency>
            <groupId>com.microsoft.azure.cognitiveservices</groupId>
            <artifactId>azure-cognitiveservices-speech</artifactId>
            <version>1.38.0</version>
        </dependency>

        <!-- Azure Key Vault -->
        <dependency>
            <groupId>com.azure</groupId>
            <artifactId>azure-identity</artifactId>
            <version>1.12.0</version>
        </dependency>
        <dependency>
            <groupId>com.azure</groupId>
            <artifactId>azure-security-keyvault-secrets</artifactId>
            <version>4.8.0</version>
        </dependency>

        <!-- Application Insights -->
        <dependency>
            <groupId>com.microsoft.applicationinsights</groupId>
            <artifactId>applicationinsights-core</artifactId>
            <version>3.5.1</version>
        </dependency>

        <!-- HTTP Client for Quotation API -->
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
            <version>4.5.14</version>
        </dependency>

        <!-- Spring Security for Azure AD B2C -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-oauth2-client</artifactId>
        </dependency>

        <!-- JSON Processing -->
        <dependency>
            <groupId>org.json</groupId>
            <artifactId>json</artifactId>
            <version>20231013</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

### 3.4 `application.properties`
The `application.properties` file contains all configurations for the application in a single block:

```properties
# PostgreSQL
spring.datasource.url=jdbc:postgresql://localhost:5432/creditcard_db
spring.datasource.username=postgres
spring.datasource.password=your-postgres-password
spring.jpa.hibernate.ddl-auto=update

# Azure Speech Service
azure.speech.key=your-speech-key
azure.speech.region=eastus

# Azure Key Vault
azure.keyvault.uri=https://voicecard-vault.vault.azure.net/
azure.keyvault.client-id=your-adb2c-client-id
azure.keyvault.client-secret=your-adb2c-client-secret
azure.keyvault.tenant-id=your-adb2c-tenant-id

# Application Insights
applicationinsights.instrumentation-key=your-instrumentation-key

# Mock Quotation API
creditcard.api.url=http://localhost:3000/api/creditcard/apply

# Azure Communication Services
acs.connection-string=endpoint=https://voicecard-acs.communication.azure.com/;accesskey=your-acs-key
acs.toll-free-number=+18001234567

# Spring Security OAuth2 for Azure AD B2C
spring.security.oauth2.client.registration.azure.client-id=your-adb2c-client-id
spring.security.oauth2.client.registration.azure.client-secret=your-adb2c-client-secret
spring.security.oauth2.client.registration.azure.scope=openid,profile
spring.security.oauth2.client.registration.azure.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.azure.redirect-uri=http://localhost:8080/login/oauth2/code/azure
spring.security.oauth2.client.provider.azure.authorization-uri=https://voicecardb2c.b2clogin.com/voicecardb2c.onmicrosoft.com/B2C_1_signup_signin/oauth2/v2.0/authorize
spring.security.oauth2.client.provider.azure.token-uri=https://voicecardb2c.b2clogin.com/voicecardb2c.onmicrosoft.com/B2C_1_signup_signin/oauth2/v2.0/token
spring.security.oauth2.client.provider.azure.user-info-uri=https://graph.microsoft.com/oidc/userinfo
spring.security.oauth2.client.provider.azure.user-name-attribute=preferred_username
```

Replace placeholders like `your-postgres-password`, `your-speech-key`, `your-acs-key`, `your-instrumentation-key`, `your-adb2c-client-id`, `your-adb2c-client-secret`, and `your-adb2c-tenant-id` with the actual values obtained from Azure CLI commands in Step 2.

### 3.5 `VoiceCardAiApplication.java`
The main application class to start the Spring Boot application:

In `src/main/java/com/voicecard/VoiceCardAiApplication.java`:

```java
package com.voicecard;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class VoiceCardAiApplication {
    public static void main(String[] args) {
        SpringApplication.run(VoiceCardAiApplication.class, args);
    }
}
```

### 3.6 `Application.java` (Model)
The data model for storing application details:

In `src/main/java/com/voicecard/model/Application.java`:

```java
package com.voicecard.model;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;

@Entity
public class Application {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private String phone;
    private double income;
    private String decision;

    // Getters and Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    public String getPhone() { return phone; }
    public void setPhone(String phone) { this.phone = phone; }
    public double getIncome() { return income; }
    public void setIncome(double income) { this.income = income; }
    public String getDecision() { return decision; }
    public void setDecision(String decision) { this.decision = decision; }
}
```

### 3.7 `ApplicationRepository.java`
The JPA repository for database operations:

In `src/main/java/com/voicecard/repository/ApplicationRepository.java`:

```java
package com.voicecard.repository;

import com.voicecard.model.Application;
import org.springframework.data.jpa.repository.JpaRepository;

public interface ApplicationRepository extends JpaRepository<Application, Long> {
}
```

### 3.8 `SpeechService.java`
The service to handle speech-to-text and text-to-speech:

In `src/main/java/com/voicecard/service/SpeechService.java`:

```java
package com.voicecard.service;

import com.microsoft.cognitiveservices.speech.*;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

@Service
public class SpeechService {
    @Value("${azure.speech.key}")
    private String speechKey;

    @Value("${azure.speech.region}")
    private String speechRegion;

    public String recognizeSpeech() throws Exception {
        SpeechConfig config = SpeechConfig.fromSubscription(speechKey, speechRegion);
        try (SpeechRecognizer recognizer = new SpeechRecognizer(config)) {
            SpeechRecognitionResult result = recognizer.recognizeOnceAsync().get();
            return result.getText().trim();
        }
    }

    public void synthesizeSpeech(String text) throws Exception {
        SpeechConfig config = SpeechConfig.fromSubscription(speechKey, speechRegion);
        try (SpeechSynthesizer synthesizer = new SpeechSynthesizer(config)) {
            synthesizer.SpeakTextAsync(text).get();
        }
    }
}
```

### 3.9 `CallingService.java`
The service to handle incoming calls to the toll-free number:

In `src/main/java/com/voicecard/service/CallingService.java`:

```java
package com.voicecard.service;

import com.azure.communication.calling.*;
import com.azure.communication.common.CommunicationTokenCredential;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.concurrent.atomic.AtomicBoolean;

@Service
public class CallingService {
    @Value("${acs.connection-string}")
    private String acsConnectionString;

    @Value("${acs.toll-free-number}")
    private String tollFreeNumber;

    private CallAgent callAgent;
    private Call currentCall;
    private final AtomicBoolean isCallActive = new AtomicBoolean(false);

    public void initializeCallAgent() throws Exception {
        CommunicationTokenCredential credential = new CommunicationTokenCredential(acsConnectionString);
        CallClient callClient = new CallClient();
        callAgent = callClient.createCallAgent(credential).get();
        callAgent.addOnIncomingCallListener(this::handleIncomingCall);
    }

    private void handleIncomingCall(IncomingCall incomingCall) {
        if (isCallActive.get()) {
            incomingCall.reject().block();
            return;
        }

        isCallActive.set(true);
        currentCall = incomingCall.accept(null).block();
        currentCall.addOnStateChangedListener(state -> {
            if (state.getState() == CallState.DISCONNECTED) {
                isCallActive.set(false);
                currentCall = null;
            }
        });
    }

    public Call getCurrentCall() {
        return currentCall;
    }

    public boolean isCallActive() {
        return isCallActive.get();
    }

    public void hangUp() {
        if (currentCall != null) {
            currentCall.hangUp(null).block();
        }
    }
}
```

### 3.10 `QuotationService.java`
The service to generate a quotation ID by calling the mock Quotation API:

In `src/main/java/com/voicecard/service/QuotationService.java`:

```java
package com.voicecard.service;

import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.UUID;

@Service
public class QuotationService {
    @Value("${creditcard.api.url}")
    private String quotationApiUrl;

    public String generateQuotationId(String name, String phone, double income) throws Exception {
        try (var client = HttpClients.createDefault()) {
            var post = new HttpPost(quotationApiUrl);
            var json = new JSONObject();
            json.put("name", name);
            json.put("phone", phone);
            json.put("income", income);
            post.setEntity(new StringEntity(json.toString()));
            post.setHeader("Content-Type", "application/json");
            var response = EntityUtils.toString(client.execute(post).getEntity());
            var responseJson = new JSONObject(response);
            // Mock a quotation ID
            String quotationId = "QUOT-" + UUID.randomUUID().toString().substring(0, 8);
            return quotationId;
        }
    }
}
```

### 3.11 `ApplicationService.java`
The service to manage the application process, including voice interaction and follow-up questions:

In `src/main/java/com/voicecard/service/ApplicationService.java`:

```java
package com.voicecard.service;

import com.voicecard.model.Application;
import com.voicecard.repository.ApplicationRepository;
import com.microsoft.applicationinsights.TelemetryClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class ApplicationService {
    private final SpeechService speechService;
    private final CallingService callingService;
    private final QuotationService quotationService;
    private final ApplicationRepository repository;
    @Autowired
    private TelemetryClient telemetryClient;

    public ApplicationService(SpeechService speechService, CallingService callingService,
                              QuotationService quotationService, ApplicationRepository repository) {
        this.speechService = speechService;
        this.callingService = callingService;
        this.quotationService = quotationService;
        this.repository = repository;
    }

    public void processApplication() throws Exception {
        // Ensure a call is active
        if (!callingService.isCallActive()) {
            throw new IllegalStateException("No active call to process.");
        }

        var app = new Application();

        // Step 1: Welcome the user and ask for their name
        speechService.synthesizeSpeech("Welcome to VoiceCard AI. This is an automated system to help you generate a credit card quotation ID. Please say your name.");
        var name = speechService.recognizeSpeech();
        app.setName(name);

        // Step 2: Ask for phone number
        speechService.synthesizeSpeech("Please say your phone number, one digit at a time, for example, 1 2 3 4 5 6 7 8 9 0.");
        var phone = speechService.recognizeSpeech();
        // Basic cleaning of the phone number (speech recognition may vary)
        phone = phone.replaceAll("[^0-9]", "");
        app.setPhone(phone);

        // Step 3: Ask for income
        speechService.synthesizeSpeech("Please say your annual income in dollars, for example, 50 thousand.");
        var incomeStr = speechService.recognizeSpeech();
        var income = parseIncome(incomeStr);
        app.setIncome(income);

        // Step 4: Generate quotation ID
        telemetryClient.trackEvent("Generating quotation ID for user: " + name);
        var quotationId = quotationService.generateQuotationId(name, phone, income);
        app.setDecision(quotationId);

        // Step 5: Save to database
        repository.save(app);

        // Step 6: Inform the user of the quotation ID
        speechService.synthesizeSpeech("Thank you, " + name + ". Your credit card quotation ID is " + quotationId + ". Please note this down.");

        // Step 7: Handle follow-up questions
        handleFollowUp();
    }

    private double parseIncome(String incomeStr) {
        // Handle common speech patterns, e.g., "50 thousand" or "50000"
        incomeStr = incomeStr.toLowerCase().replaceAll("[^0-9\\s]", "");
        if (incomeStr.contains("thousand")) {
            var number = Double.parseDouble(incomeStr.replace("thousand", "").trim());
            return number * 1000;
        }
        return Double.parseDouble(incomeStr.trim());
    }

    private void handleFollowUp() throws Exception {
        speechService.synthesizeSpeech("Do you have any follow-up questions about your quotation? Please say yes or no.");
        var response = speechService.recognizeSpeech().toLowerCase();
        if (response.contains("yes")) {
            speechService.synthesizeSpeech("Please state your question.");
            var question = speechService.recognizeSpeech();
            telemetryClient.trackEvent("Follow-up question from user: " + question);
            speechService.synthesizeSpeech("Thank you for your question: " + question + ". A customer care representative will follow up with you soon.");
        }
        speechService.synthesizeSpeech("Thank you for using VoiceCard AI. Goodbye!");
        callingService.hangUp();
    }
}
```

### 3.12 `KeyVaultService.java`
The service to retrieve secrets from Azure Key Vault:

In `src/main/java/com/voicecard/service/KeyVaultService.java`:

```java
package com.voicecard.service;

import com.azure.identity.DefaultAzureCredentialBuilder;
import com.azure.security.keyvault.secrets.SecretClient;
import com.azure.security.keyvault.secrets.SecretClientBuilder;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

@Service
public class KeyVaultService {
    private final SecretClient secretClient;

    public KeyVaultService(@Value("${azure.keyvault.uri}") String keyVaultUri) {
        this.secretClient = new SecretClientBuilder()
                .vaultUrl(keyVaultUri)
                .credential(new DefaultAzureCredentialBuilder().build())
                .buildClient();
    }

    public String getSecret(String secretName) {
        return secretClient.getSecret(secretName).getValue();
    }
}
```

### 3.13 `CallHandlerController.java`
The controller to handle incoming call events from ACS:

In `src/main/java/com/voicecard/controller/CallHandlerController.java`:

```java
package com.voicecard.controller;

import com.voicecard.service.ApplicationService;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class CallHandlerController {
    private final ApplicationService applicationService;

    public CallHandlerController(ApplicationService applicationService) {
        this.applicationService = applicationService;
    }

    @PostMapping("/webhook")
    public void handleCallEvent(@RequestBody String event) throws Exception {
        // ACS sends call events to this webhook
        // For simplicity, we assume the event indicates a new incoming call
        applicationService.processApplication();
    }
}
```

### 3.14 `AppInsightsConfig.java`
The configuration for Application Insights:

In `src/main/java/com/voicecard/config/AppInsightsConfig.java`:

```java
package com.voicecard.config;

import com.microsoft.applicationinsights.TelemetryClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class AppInsightsConfig {
    @Value("${applicationinsights.instrumentation-key}")
    private String instrumentationKey;

    @Bean
    public TelemetryClient telemetryClient() {
        TelemetryClient client = new TelemetryClient();
        client.getContext().setInstrumentationKey(instrumentationKey);
        return client;
    }
}
```

### 3.15 `SecurityConfig.java`
The security configuration for Azure AD B2C:

In `src/main/java/com/voicecard/config/SecurityConfig.java`:

```java
package com.voicecard.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/webhook").permitAll() // Allow ACS webhook
                .anyRequest().authenticated()
            )
            .oauth2Login();
        return http.build();
    }
}
```

### 3.16 Create the Mock API
The mock Quotation API using Node.js:

In `mock-creditcard-api/server.js`:

```javascript
const express = require('express');
const app = express();
app.use(express.json());

app.post('/api/creditcard/apply', (req, res) => {
    const { name, income, phone } = req.body;
    const quotationId = `QUOT-${Math.random().toString(36).substring(2, 8)}`;
    res.json({ name, phone, quotationId });
});

app.listen(3000, () => console.log('Mock Quotation API running on port 3000'));
```

To set up the mock API:
1. Create a directory: `mock-creditcard-api`.
2. Initialize a Node.js project:
   ```bash
   cd mock-creditcard-api
   npm init -y
   npm install express
   ```
3. Save the above code as `server.js`.

---

## Step 4: Set Up a Webhook for Incoming Calls

To receive incoming call events, ACS needs a public webhook URL. For local testing, use `ngrok` to expose your local server.

1. **Install `ngrok`:**
   - Download and install [ngrok](https://ngrok.com/).
   - Start `ngrok` to expose your local server:
     ```bash
     ngrok http 8080
     ```
   - Note the public URL, e.g., `https://your-ngrok-subdomain.ngrok.io`.

2. **Configure ACS to Send Events to the Webhook:**
   ```bash
   az communication update \
       --name voicecard-acs \
       --event-subscription-url "https://your-ngrok-subdomain.ngrok.io/webhook" \
       --resource-group voicecard-rg
   ```

---

## Step 5: Test the Application

1. **Start the Mock API:**
   ```bash
   cd mock-creditcard-api
   node server.js
   ```

2. **Start the Spring Boot Application:**
   ```bash
   cd voicecard-ai
   mvn spring-boot:run
   ```

3. **Call the Toll-Free Number:**
   - Use a phone to dial the toll-free number (`+18001234567`).
   - The system will answer the call and guide you through the process via voice:
     - "Welcome to VoiceCard AI... Please say your name."
     - "Please say your phone number, one digit at a time..."
     - "Please say your annual income..."
     - "Your credit card quotation ID is QUOT-XXXXXX..."
     - "Do you have any follow-up questions?..."
   - The call will end after the process is complete.

4. **Verify Database and Monitoring:**
   - Check the database:
     ```bash
     psql -U postgres -d creditcard_db
     SELECT * FROM application;
     ```
   - Check Application Insights in the Azure Portal for logs.

---

## Accessibility Considerations

- **Voice-Only Interaction:** The entire process is voice-driven, with clear, slow prompts to assist visually challenged users.
- **Error Handling:** The system includes basic input parsing (e.g., for phone numbers and income) to handle speech recognition errors.
- **Follow-Up Support:** Users can ask follow-up questions, which are logged for later follow-up by a representative.

---

## Summary

- Built a voice-driven application for visually challenged users to generate credit card quotation IDs.
- Used Azure Communication Services to handle incoming calls to a toll-free number.
- Integrated Azure Speech Services for real-time voice interaction.
- Generated quotation IDs via a mock API.
- Supported follow-up questions via voice, with responses logged for later action.
- Ensured accessibility with clear, voice-only prompts and error handling.

This solution is now fully tailored for visually challenged users, running on Java 21, and using real-time calling with voice interaction.
```

---